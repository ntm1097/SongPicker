<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" href="/Assets/favicon.ico" type="image/x-icon" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <title>Clearly Praise</title>
  </head>
  <body>
    <div class="container">
      <div class="new__format">
        <div class="song__list">
          <li>
            <input
              type="text"
              class="song__input"
              placeholder="Enter Song Here"
            />
            <div class="check__box"></div>
          </li>
          <li>
            <input
              type="text"
              class="song__input"
              placeholder="Enter Song Here"
            />
            <div class="check__box"></div>
          </li>
          <li>
            <input
              type="text"
              class="song__input"
              placeholder="Enter Song Here"
            />
            <div class="check__box" onclick="handleCheckBoxClick(event)"></div>
          </li>
          <li>
            <input
              type="text"
              class="song__input"
              placeholder="Enter Song Here"
            />
            <div class="check__box"></div>
          </li>
          <li>
            <input
              type="text"
              class="song__input"
              placeholder="Enter Song Here"
            />
            <div class="check__box"></div>
          </li>
        </div>
                <input class="input__date" type="text" placeholder="Select Date" readonly />
        <div id="calendar__popup" class="calendar__popup" style="display: none;">
          <div class="calendar__header">
            <button id="prev__month" class="calendar__nav">&lt;</button>
            <span id="month__year"></span>
            <button id="next__month" class="calendar__nav">&gt;</button>
          </div>
          <div class="calendar__weekdays">
            <div>Sun</div>
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
          </div>
          <div id="calendar__days" class="calendar__days">
            <!-- Days will be populated by JavaScript -->
          </div>
        </div>
        <div class="buttons">
          <button class="btn">Auto Generate</button>
          <button class="btn">Submit</button>
          <input type="file" id="file__upload" accept=".xlsx,.xls,.docx,.doc" />
          <button id="upload__btn" class="btn">Upload File</button>
        </div>
      </div>
    </div>

    <!-- Full-screen file preview overlay -->
    <div id="file__preview__overlay" class="file__preview__overlay" style="display: none;">
      <div class="file__preview__container">
        <div class="buttons">
            <button id="use__file__data" class="btn">Use This Data</button>
            <button id="close__preview__btn" class="btn">Cancel</button>
          </div>
        <div class="file__preview__header">
          <h2>File Preview</h2>
          <button id="close__preview" class="close__btn">&times;</button>
        </div>
        <div class="new__format">
          <input id="preview__date" class="input__date" type="date" readonly />
          <div class="song__list" id="preview__song__list">
            <!-- Songs will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Autocomplete dropdown container -->
    <div id="autocomplete__dropdown" class="autocomplete__dropdown" style="display: none;">
      <ul id="autocomplete__list"></ul>
    </div>
  </body>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOX7iUIR-GDnfpY0wQ_oOegJUYOJTM9LE",
      authDomain: "hpbc-songpicker.firebaseapp.com",
      databaseURL: "https://hpbc-songpicker-default-rtdb.firebaseio.com",
      projectId: "hpbc-songpicker",
      storageBucket: "hpbc-songpicker.firebasestorage.app",
      messagingSenderId: "677978452426",
      appId: "1:677978452426:web:b81f46a94cfe0380295f33",
    };

    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
  </script>
  <script src="index.js"></script>
  <script>
    // Auto Generate Songs Logic
    async function getAvailableSongs() {
      try {
        // Define Christmas songs to exclude from auto-generation
        const christmasSongs = [
          "angels we have heard on high",
          "away in a manger", 
          "emmanuel hallowed ground",
          "joy to the world",
          "angels from the realms of glory",
          "go tell it on the mountain",
          "o holy night",
          "o come o come emmanuel", 
          'he shall reign forevermore', 
          "rejoice",
          "the first noel", 
          "silent night",
          "what child is this",
          "it came upon the midnight clear",
          "o come all ye faithful", 
          "o little town"
        ];

        // Get all songs from the database
        const songsSnapshot = await db.collection('songs').get();
        const allSongs = songsSnapshot.docs.map(doc => ({
          id: doc.id,
          name: doc.data().name || doc.id,
          count: doc.data().count || 0
        })).filter(song => 
          // Exclude Christmas songs from auto-generation
          !christmasSongs.includes(song.name.toLowerCase().trim())
        );

        // Get songs used in the last 8 weeks from formats collection
        const sixWeeksAgo = new Date();
        sixWeeksAgo.setDate(sixWeeksAgo.getDate() - 56);

        const recentFormatsSnapshot = await db.collection('formats')
          .where('date', '>=', sixWeeksAgo.toISOString().split('T')[0])
          .get();

        // Also check 'weeks' collection for recent usage
        const recentWeeksSnapshot = await db.collection('weeks')
          .where('date', '>=', firebase.firestore.Timestamp.fromDate(sixWeeksAgo))
          .get();

        // Collect all recently used songs
        const recentlyUsedSongs = new Set();
        
        // Check formats collection
        recentFormatsSnapshot.docs.forEach(doc => {
          const formatData = doc.data();
          if (formatData.songs && Array.isArray(formatData.songs)) {
            formatData.songs.forEach(song => {
              if (typeof song === 'string') {
                recentlyUsedSongs.add(song.toLowerCase().trim());
              } else if (song && song.name) {
                recentlyUsedSongs.add(song.name.toLowerCase().trim());
              }
            });
          }
        });

        // Check weeks collection
        recentWeeksSnapshot.docs.forEach(doc => {
          const weekData = doc.data();
          if (weekData.songs && Array.isArray(weekData.songs)) {
            weekData.songs.forEach(song => {
              if (typeof song === 'string') {
                recentlyUsedSongs.add(song.toLowerCase().trim());
              } else if (song && song.name) {
                recentlyUsedSongs.add(song.name.toLowerCase().trim());
              }
            });
          }
        });

        // Filter out recently used songs
        const availableSongs = allSongs.filter(song => 
          !recentlyUsedSongs.has(song.name.toLowerCase().trim())
        );

        // Prioritize songs with lower counts (least used overall)
        availableSongs.sort((a, b) => a.count - b.count);

        return availableSongs;
      } catch (error) {
        console.error('Error fetching available songs:', error);
        return [];
      }
    }

    function getRandomSongs(songs, count = 5) {
      const shuffled = [...songs].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, Math.min(count, shuffled.length));
    }

    function handleCheckBoxClick(event) {
      const checkbox = event.target
      checkbox.style.borderColor = "red";
    }




    async function autoGenerateSongs() {
      try {
        const availableSongs = await getAvailableSongs();
        
        if (availableSongs.length === 0) {
          alert('No songs available that haven\'t been used in the last 6 weeks.');
          return;
        }

        const selectedSongs = getRandomSongs(availableSongs, 5);
        const songInputs = document.querySelectorAll('.song__input');

        

        // Populate with selected songs
        selectedSongs.forEach((song, index) => {
          if (index < songInputs.length) {
            songInputs[index].value = song.name;
          }
        });

        console.log(`Generated ${selectedSongs.length} songs from ${availableSongs.length} available songs`);
      } catch (error) {
        console.error('Error auto-generating songs:', error);
        alert('Error generating songs. Please try again.');
      }
    }

    /* Calendar Popup */
    document.addEventListener("DOMContentLoaded", function() {
      const dateInput = document.querySelector('.input__date');
      const calendarPopup = document.getElementById('calendar__popup');
      const monthYearSpan = document.getElementById('month__year');
      const calendarDays = document.getElementById('calendar__days');
      const prevMonthBtn = document.getElementById('prev__month');
      const nextMonthBtn = document.getElementById('next__month');
    
      let currentDate = new Date();
      let selectedDate = null;
    
      const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
    
      
      dateInput.addEventListener('click', function(e) {
        e.stopPropagation();
        const rect = dateInput.getBoundingClientRect();
        calendarPopup.style.display = 'block';
        calendarPopup.style.position = 'absolute';
        calendarPopup.style.top = (rect.top - calendarPopup.offsetHeight - 160) + 'px';
        calendarPopup.style.left = rect.left + 'px';
        renderCalendar();
      });
    
      // Hide calendar when clicking outside
      document.addEventListener('click', function(e) {
        if (!calendarPopup.contains(e.target) && e.target !== dateInput) {
          calendarPopup.style.display = 'none';
        }
      });
    
      // Navigation buttons
      prevMonthBtn.addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });
    
      nextMonthBtn.addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });
    
      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Update month/year display
        monthYearSpan.textContent = `${months[month]} ${year}`;
        
        // Clear previous days
        calendarDays.innerHTML = '';
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        const today = new Date();
        
        // Add previous month's trailing days
        for (let i = firstDay - 1; i >= 0; i--) {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'calendar__day other-month';
          dayDiv.textContent = daysInPrevMonth - i;
          calendarDays.appendChild(dayDiv);
        }
        
        // Add current month's days
        for (let day = 1; day <= daysInMonth; day++) {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'calendar__day';
          dayDiv.textContent = day;
          
          // Check if it's today
          if (year === today.getFullYear() && 
              month === today.getMonth() && 
              day === today.getDate()) {
            dayDiv.classList.add('today');
          }
          
          // Check if it's selected date
          if (selectedDate && 
              year === selectedDate.getFullYear() && 
              month === selectedDate.getMonth() && 
              day === selectedDate.getDate()) {
            dayDiv.classList.add('active');
          }
          
          // Add click event
          dayDiv.addEventListener('click', function() {
            selectedDate = new Date(year, month, day);
            dateInput.value = formatDate(selectedDate);
            calendarPopup.style.display = 'none';
            
            // Remove previous active class and add to clicked day
            document.querySelectorAll('.calendar__day.active').forEach(d => d.classList.remove('active'));
            dayDiv.classList.add('active');
          });
          
          calendarDays.appendChild(dayDiv);
        }
        
        // Add next month's leading days
        const totalCells = calendarDays.children.length;
        const remainingCells = 42 - totalCells; // 6 rows Ã— 7 days
        for (let day = 1; day <= remainingCells && totalCells < 35; day++) {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'calendar__day other-month';
          dayDiv.textContent = day;
          calendarDays.appendChild(dayDiv);
        }
      }
    
      function formatDate(date) {
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${month}/${day}/${year}`;
      }
    });

    // Autocomplete functionality
    let allSongsForAutocomplete = [];
    let currentActiveInput = null;

    async function loadSongsForAutocomplete() {
      try {
        const songsSnapshot = await db.collection('songs').get();
        allSongsForAutocomplete = songsSnapshot.docs.map(doc => {
          const songData = doc.data();
          return songData.name || doc.id;
        }).sort();
        console.log('Loaded songs for autocomplete:', allSongsForAutocomplete.length);
      } catch (error) {
        console.error('Error loading songs for autocomplete:', error);
      }
    }

    function setupAutocomplete() {
      const songInputs = document.querySelectorAll('.song__input');
      const dropdown = document.getElementById('autocomplete__dropdown');
      const dropdownList = document.getElementById('autocomplete__list');

      songInputs.forEach(input => {
        input.addEventListener('input', function(e) {
          currentActiveInput = this;
          const query = this.value.toLowerCase().trim();
          
          if (query.length < 2) {
            hideDropdown();
            return;
          }

          const matches = allSongsForAutocomplete.filter(song => 
            song.toLowerCase().includes(query)
          ).slice(0, 5); // Limit to 5 suggestions

          if (matches.length > 0) {
            showDropdown(matches, this);
          } else {
            hideDropdown();
          }
        });

        input.addEventListener('blur', function() {
          // Delay hiding dropdown to allow clicking on suggestions
          setTimeout(() => {
            hideDropdown();
          }, 200);
        });

        input.addEventListener('keydown', function(e) {
          const dropdown = document.getElementById('autocomplete__dropdown');
          const suggestions = dropdown.querySelectorAll('li');
          const activeSuggestion = dropdown.querySelector('li.active');
          let activeIndex = Array.from(suggestions).indexOf(activeSuggestion);

          if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = activeIndex < suggestions.length - 1 ? activeIndex + 1 : 0;
            updateActiveSuggestion(suggestions, activeIndex);
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = activeIndex > 0 ? activeIndex - 1 : suggestions.length - 1;
            updateActiveSuggestion(suggestions, activeIndex);
          } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeSuggestion) {
              selectSuggestion(activeSuggestion.textContent, this);
            }
          } else if (e.key === 'Escape') {
            hideDropdown();
          }
        });
      });
    }

    function showDropdown(matches, inputElement) {
      const dropdown = document.getElementById('autocomplete__dropdown');
      const dropdownList = document.getElementById('autocomplete__list');
      
      dropdownList.innerHTML = '';
      
      matches.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = song;
        li.className = index === 0 ? 'active' : '';
        li.addEventListener('mousedown', function() {
          selectSuggestion(song, inputElement);
        });
        li.addEventListener('mouseenter', function() {
          updateActiveSuggestion(dropdownList.querySelectorAll('li'), index);
        });
        dropdownList.appendChild(li);
      });

      // Position dropdown below the input
      const rect = inputElement.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.width = `${rect.width}px`;
      dropdown.style.display = 'block';
    }

    function hideDropdown() {
      const dropdown = document.getElementById('autocomplete__dropdown');
      dropdown.style.display = 'none';
    }

    function updateActiveSuggestion(suggestions, activeIndex) {
      suggestions.forEach((suggestion, index) => {
        suggestion.className = index === activeIndex ? 'active' : '';
      });
    }

    function selectSuggestion(song, inputElement) {
      inputElement.value = song;
      hideDropdown();
      inputElement.focus();
    }

    // Add event listener to auto generate button
    document.addEventListener('DOMContentLoaded', async function() {
      // Load songs for autocomplete
      await loadSongsForAutocomplete();
      setupAutocomplete();

      const autoGenerateBtn = document.querySelector('.btn'); // First button is Auto Generate
      if (autoGenerateBtn && autoGenerateBtn.textContent.trim() === 'Auto Generate') {
        autoGenerateBtn.addEventListener('click', autoGenerateSongs);
      }
    });
  </script>
</body>
</html>
